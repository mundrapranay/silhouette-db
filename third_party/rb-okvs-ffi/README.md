# RB-OKVS FFI Wrapper

This crate provides C-compatible FFI bindings for the RB-OKVS library, enabling integration with Go via cgo.

## Overview

The FFI wrapper exposes two main functions:
- `rb_okvs_encode`: Encode string keys â†’ float64 values into an OKVS blob
- `rb_okvs_decode`: Decode a float64 value from an OKVS blob using a string key

## Build

Build the static library:

```bash
cargo build --release
```

This creates:
- `target/release/librbokvsffi.a` (static library)
- `target/release/librbokvsffi.dylib` (dynamic library)
- `rb_okvs_ffi.h` (C header file, generated by cbindgen)

## Usage

The FFI functions handle:
- **Key hashing**: String keys are hashed to 8-byte `OkvsKey` using BLAKE2b512
- **Value conversion**: Float64 values are converted to `OkvsValue<8>` (8 bytes, little-endian)
- **Memory management**: Buffers are allocated in Rust and must be freed using `rb_okvs_free_buffer`

### Encoding Format

The encoded blob format is:
```
[params_len (8 bytes)] [kv_count (8)] [columns (8)] [band_width (8)] [encoding_len (8)] [encoding data...]
```

Where encoding data is a sequence of `OkvsValue<8>` values.

## Testing

Run tests:

```bash
cargo test
```

Run FFI tests specifically:

```bash
cargo test --test ffi_test
```

## Integration with Go

See `internal/crypto/okvs_impl.go` (to be created) for Go cgo bindings.

